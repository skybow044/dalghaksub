<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>نمایش مسیر ابزار G-code</title>
    <style>
      :root {
        color-scheme: light dark;
      }
      body {
        margin: 0;
        font-family: "Vazirmatn", "Segoe UI", sans-serif;
        background: #f3f4f6;
        color: #1f2933;
      }
      @media (prefers-color-scheme: dark) {
        body {
          background: #0f172a;
          color: #e2e8f0;
        }
      }
      header {
        background: rgba(15, 23, 42, 0.08);
        backdrop-filter: blur(8px);
        padding: 1.5rem 2rem;
        position: sticky;
        top: 0;
        display: flex;
        justify-content: center;
        border-bottom: 1px solid rgba(148, 163, 184, 0.4);
      }
      main {
        max-width: 1100px;
        margin: 2rem auto;
        padding: 0 1.5rem 4rem;
        display: grid;
        gap: 1.5rem;
      }
      .panel {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 1rem;
        box-shadow: 0 20px 35px rgba(15, 23, 42, 0.08);
        border: 1px solid rgba(148, 163, 184, 0.3);
        backdrop-filter: blur(6px);
        padding: 1.5rem;
      }
      @media (prefers-color-scheme: dark) {
        .panel {
          background: rgba(15, 23, 42, 0.85);
          border-color: rgba(148, 163, 184, 0.2);
        }
      }
      textarea {
        width: 100%;
        min-height: 16rem;
        border-radius: 0.75rem;
        border: 1px solid rgba(148, 163, 184, 0.6);
        padding: 1rem 1.25rem;
        resize: vertical;
        font-size: 0.95rem;
        line-height: 1.6;
        direction: ltr;
        background: inherit;
        color: inherit;
      }
      textarea:focus {
        outline: 2px solid #6366f1;
        border-color: #6366f1;
      }
      button {
        background: linear-gradient(135deg, #4f46e5, #6366f1);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 9999px;
        font-size: 1rem;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 30px rgba(79, 70, 229, 0.35);
      }
      canvas {
        width: 100%;
        height: 500px;
        background: radial-gradient(circle at top, rgba(99, 102, 241, 0.08), transparent 70%);
        border-radius: 1rem;
        border: 1px solid rgba(148, 163, 184, 0.25);
      }
      .status {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        font-size: 0.9rem;
        color: rgba(15, 23, 42, 0.8);
      }
      @media (prefers-color-scheme: dark) {
        .status {
          color: rgba(226, 232, 240, 0.75);
        }
      }
      .status span {
        background: rgba(79, 70, 229, 0.12);
        padding: 0.35rem 0.9rem;
        border-radius: 999px;
      }
      .error {
        color: #ef4444;
        margin-top: 0.75rem;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>شبیه‌ساز ساده مسیر ابزار G-code</h1>
    </header>
    <main>
      <section class="panel">
        <h2>کد جی را وارد کنید</h2>
        <p>
          خطوط شامل دستورات <code>G0</code>، <code>G1</code>، <code>G2</code> و <code>G3</code>
          پشتیبانی می‌شوند. برای آزمودن می‌توانید نمونه پیش‌فرض را ویرایش کنید.
        </p>
        <textarea id="gcode" spellcheck="false"></textarea>
        <div style="margin-top: 1rem; display: flex; gap: 0.75rem; flex-wrap: wrap;">
          <button id="render">نمایش مسیر</button>
          <button id="sample" type="button" style="background: linear-gradient(135deg, #0ea5e9, #38bdf8);">
            نمونه پیش‌فرض
          </button>
        </div>
        <div id="error" class="error" role="alert"></div>
      </section>
      <section class="panel">
        <h2>نمایش دوبعدی</h2>
        <p>مسیر حرکت ابزار از دید بالا (محور Z به سمت خارج صفحه) رسم می‌شود.</p>
        <canvas id="viewer" width="900" height="500"></canvas>
        <div id="status" class="status" aria-live="polite"></div>
      </section>
    </main>

    <script>
      const textarea = document.getElementById('gcode');
      const renderBtn = document.getElementById('render');
      const sampleBtn = document.getElementById('sample');
      const canvas = document.getElementById('viewer');
      const ctx = canvas.getContext('2d');
      const statusEl = document.getElementById('status');
      const errorEl = document.getElementById('error');

      const SAMPLE = `G90 ; absolute positioning\nG21 ; millimeters\n\nG0 X0 Y0\nG1 X20 Y0 F800\nG1 X20 Y20\nG1 X0 Y20\nG1 X0 Y0\n\nG0 X10 Y10\nG2 X20 Y10 I5 J0\nG2 X10 Y10 I-5 J0\n\nG0 X30 Y0\nG1 X60 Y0\nG3 X60 Y30 I0 J15\nG1 X30 Y30\nG3 X30 Y0 I0 J-15\nM30`;

      sampleBtn.addEventListener('click', () => {
        textarea.value = SAMPLE;
        drawPath(parseGCode(SAMPLE));
      });

      renderBtn.addEventListener('click', () => {
        const result = parseGCode(textarea.value);
        drawPath(result);
      });

      function parseGCode(input) {
        const lines = input.split(/\r?\n/);
        const segments = [];
        const warnings = [];
        let modeAbsolute = true;
        let current = { x: 0, y: 0, z: 0 };
        let plane = 'XY';

        for (const raw of lines) {
          let line = raw.trim();
          if (!line || line.startsWith(';')) continue;
          line = line.replace(/\([^)]*\)/g, '').split(';')[0].trim();
          if (!line) continue;

          const words = line.match(/[A-Za-z][+-]?\d*\.?\d*/g) || [];
          if (!words.length) continue;

          const commandWord = words.find((w) => /^[GMgm]/.test(w));
          let code = commandWord ? commandWord.toUpperCase() : '';

          if (code === 'G90') {
            modeAbsolute = true;
            continue;
          }
          if (code === 'G91') {
            modeAbsolute = false;
            continue;
          }
          if (code === 'G17') {
            plane = 'XY';
            continue;
          }
          if (code === 'G18') {
            plane = 'XZ';
            continue;
          }
          if (code === 'G19') {
            plane = 'YZ';
            continue;
          }

          const coords = {};
          for (const word of words) {
            const letter = word[0].toUpperCase();
            const value = parseFloat(word.slice(1));
            if (!isNaN(value)) {
              coords[letter] = value;
            }
          }

          const target = { ...current };
          if ('X' in coords) target.x = modeAbsolute ? coords.X : current.x + coords.X;
          if ('Y' in coords) target.y = modeAbsolute ? coords.Y : current.y + coords.Y;
          if ('Z' in coords) target.z = modeAbsolute ? coords.Z : current.z + coords.Z;

          const gMatch = /G(\d+)/i.exec(code);
          if (gMatch) {
            const gCode = parseInt(gMatch[1], 10);
            if (gCode === 0 || gCode === 1) {
              segments.push({
                type: gCode === 0 ? 'rapid' : 'linear',
                points: [
                  { x: current.x, y: current.y },
                  { x: target.x, y: target.y },
                ],
              });
              current = target;
              continue;
            }
            if ((gCode === 2 || gCode === 3) && plane === 'XY') {
              const cw = gCode === 2;
              const hasIJ = 'I' in coords || 'J' in coords;
              if (!hasIJ) {
                warnings.push('قوس بدون پارامترهای I و J نادیده گرفته شد.');
                current = target;
                continue;
              }
              const center = {
                x: current.x + (coords.I || 0),
                y: current.y + (coords.J || 0),
              };
              const radius = Math.hypot(current.x - center.x, current.y - center.y);
              const startAngle = Math.atan2(current.y - center.y, current.x - center.x);
              let endAngle = Math.atan2(target.y - center.y, target.x - center.x);
              let sweep = endAngle - startAngle;
              if (cw && sweep > 0) {
                sweep -= Math.PI * 2;
              } else if (!cw && sweep < 0) {
                sweep += Math.PI * 2;
              }
              const steps = Math.max(12, Math.min(90, Math.round(Math.abs(sweep) / (Math.PI / 18))));
              const arcPoints = [{ x: current.x, y: current.y }];
              for (let i = 1; i <= steps; i++) {
                const angle = startAngle + (sweep * i) / steps;
                arcPoints.push({
                  x: center.x + Math.cos(angle) * radius,
                  y: center.y + Math.sin(angle) * radius,
                });
              }
              segments.push({ type: 'arc', points: arcPoints });
              current = target;
              continue;
            }
          }
        }
        return { segments, warnings };
      }

      function drawPath(result) {
        const { segments, warnings } = result;
        errorEl.textContent = warnings.join('\n');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        statusEl.innerHTML = '';

        if (!segments.length) {
          statusEl.textContent = 'هیچ مسیری یافت نشد.';
          return;
        }

        let minX = Infinity;
        let maxX = -Infinity;
        let minY = Infinity;
        let maxY = -Infinity;
        for (const segment of segments) {
          for (const point of segment.points) {
            if (!isFinite(point.x) || !isFinite(point.y)) continue;
            minX = Math.min(minX, point.x);
            maxX = Math.max(maxX, point.x);
            minY = Math.min(minY, point.y);
            maxY = Math.max(maxY, point.y);
          }
        }

        if (!isFinite(minX) || !isFinite(minY)) {
          statusEl.textContent = 'نقاط معتبر برای ترسیم یافت نشد.';
          return;
        }

        const padding = 30;
        const width = maxX - minX || 1;
        const height = maxY - minY || 1;
        const scale = Math.min(
          (canvas.width - padding * 2) / width,
          (canvas.height - padding * 2) / height
        );

        function toScreen({ x, y }) {
          return {
            x: padding + (x - minX) * scale,
            y: canvas.height - (padding + (y - minY) * scale),
          };
        }

        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        for (const segment of segments) {
          const screenPoints = segment.points.map(toScreen);
          ctx.beginPath();
          ctx.moveTo(screenPoints[0].x, screenPoints[0].y);
          for (let i = 1; i < screenPoints.length; i++) {
            ctx.lineTo(screenPoints[i].x, screenPoints[i].y);
          }
          if (segment.type === 'rapid') {
            ctx.strokeStyle = 'rgba(251, 191, 36, 0.9)';
            ctx.setLineDash([8, 6]);
            ctx.lineWidth = 2;
          } else if (segment.type === 'arc') {
            ctx.strokeStyle = 'rgba(129, 140, 248, 0.95)';
            ctx.setLineDash([]);
            ctx.lineWidth = 3;
          } else {
            ctx.strokeStyle = 'rgba(59, 130, 246, 0.95)';
            ctx.setLineDash([]);
            ctx.lineWidth = 3;
          }
          ctx.stroke();
        }

        statusEl.innerHTML = `
          <span>تعداد قطعات: ${segments.length}</span>
          <span>طول مسیر در محور X: ${(maxX - minX).toFixed(2)}</span>
          <span>طول مسیر در محور Y: ${(maxY - minY).toFixed(2)}</span>
          <span>مقیاس نمایش: ${scale.toFixed(2)} px/واحد</span>
        `;
      }

      // بارگذاری نمونه اولیه هنگام ورود
      textarea.value = SAMPLE;
      drawPath(parseGCode(SAMPLE));
    </script>
  </body>
</html>
